# --- Instalação de pacotes ---
!pip install rasterio
!pip install numpy
!pip install matplotlib
!pip install pymannkendall

# --- Montar o Google Drive ---
from google.colab import drive
drive.mount('/content/drive')

# --- Bibliotecas ---
import os
import numpy as np
import rasterio
from rasterio.plot import show
import matplotlib.pyplot as plt
import pymannkendall as mk
from glob import glob

# --- Caminho para as imagens no Google Drive ---
base_path = '/content/drive/My Drive/MESTRADO/01. DADOS/GEE_LST_Verao_RJ_L8'

# Lista de arquivos .tif que seguem o padrão mediana_verao_L8_YYYY.tif
# O padrão foi corrigido para 'mediana_verao_L8_*.tif'
tif_files = sorted(glob(os.path.join(base_path, 'mediana_verao_L8_*.tif')))

# Adicionar uma verificação para garantir que arquivos foram encontrados
if not tif_files:
    print(f"Erro: Nenhum arquivo .tif encontrado no caminho: {base_path} com o padrão 'mediana_verao_L8_*.tif'")
else:
    # Carregar todas as imagens como array 3D (camadas: tempo, altura, largura)
    stack = []
    # Initialise src to None before the loop
    src = None
    for tif in tif_files:
        with rasterio.open(tif) as src:
            stack.append(src.read(1))  # lê banda única

    # Check if src was successfully assigned in the loop
    if src is None:
        print("Erro: Não foi possível abrir nenhum arquivo GeoTIFF.")
    else:
        meta = src.meta.copy()  # metadata para salvar depois

        stack_array = np.stack(stack, axis=0)  # shape: (tempo, altura, largura)

        # --- Função para tendência de todos os pixels ---
        def calc_kendall_tau(pixel_series):
            # remove valores nulos
            pixel_series = pixel_series[~np.isnan(pixel_series)]
            if len(pixel_series) < 3:
                return np.nan
            result = mk.original_test(pixel_series)
            return result.Tau

        # --- Aplicar função em todos os pixels ---
        def apply_mann_kendall(stack_array):
            time_len, rows, cols = stack_array.shape
            output = np.full((rows, cols), np.nan, dtype=np.float32)

            for i in range(rows):
                for j in range(cols):
                    pixel_series = stack_array[:, i, j]
                    if np.all(np.isnan(pixel_series)):
                        continue
                    output[i, j] = calc_kendall_tau(pixel_series)

            return output

        # --- Rodar análise para todos os pixels ---
        print("Calculando tendência para todos os pixels...")
        trend_all = apply_mann_kendall(stack_array)

        # --- Visualizar ---
        plt.figure(figsize=(10, 6))
        plt.title("Tendência de Temperatura de Superfície no Verão (2014–2023)")
        plt.imshow(trend_all, cmap='terrain_r')
        plt.colorbar(label='Tau de Kendall')
        plt.show()

        # --- Salvar resultado em arquivo GeoTIFF ---
        meta.update(dtype=rasterio.float32, count=1)

        output_path = os.path.join(base_path, 'Tendencia_Kendall_verao_L8.tif')

        with rasterio.open(output_path, 'w', **meta) as dst:
            dst.write(trend_all, 1)

        print(f"Arquivo salvo: {output_path}")
